# 広告システム
## 起動方法
Dockerコンテナ起動をしてください。
```
docker compose build
docker compose up -d
```
Webコンテナに入り、パッケージインストール・webサーバー起動
```
// コンテナに入る
docker exec -it nuxtAd bash
// パッケージインストール
// コンテナ起動時にインストールするようにしたが、値の状態管理を行うpiniaがうまく入らずコンテナ内で改めてインストール。要改善。
npm i
// webサーバー起動
npm run dev
```
## 擬似広告を動かして確認する
1. 管理画面ログイン(http://localhost/admin/login)
    1. ユーザーID: admin, パスワード: pass
2. プロモーション発行(http://localhost/admin/issuePromotion)
    1. プロモーション名を記入して「作成」
    2. 発行完了画面は実際の広告システムを想定しているので色々手順が書いてありますが、  
       promotionId = "xxxxxxxx"とある""の中のプロモーションIDだけコピーしてください。
3. プロモーションの設置
    1. 広告リンクを設置するメディアページ(front/pages/media/index.vue)と  
       広告主側の成果発生ページ(front/pages/client/conversion.vue)にタグを設置します。
       本環境ではスクリプトタグはすでに書いてあるので、promotionId = "xxxxxxxx"の中に先ほどコピーしたIDを入れてください。
4. 成果発生させる
    1. メディアページ(http://localhost/media/ )で「広告リンク」をクリック→商品購入
    2. バックエンドをメインで作っているのでフロントは超簡素です（言い訳）
5. 管理画面で成果を確認する(http://localhost/admin/showResults)
## システム概要
オーソドックスな広告の仕組みを実装しました。  
プロモーションを発行して、タグをメディアと広告主側ページに貼り付けると、クリック・成果発生をトラッキングします。  
  
仕組みとしては単純で、広告リンククリック時に広告サーバーでクリックIDの発行・クリック情報（クリックID,プロモーションID）の保存をし、
広告主側のページでクリックIDを引き継いで成果発生時に広告サーバーでクリックIDを突合して重複判定・成果判定を行います。  
  
広告クリック時の実装については、LP直リンクパターンと、広告サーバー側で302リダイレクトをかけるパターンを用意しました。  
リダイレクトパターンの方がメディアの実装は楽ですが直リンクを好む場合もありうるので。
  
広告といえばCookieのイメージがありますが、AppleのITPをはじめとするプライバシー規制の厳格化により  
Cookieの利用の制限があり、3rdPartyCookieはほぼ使用できず、1stPartyCookieもJSで焼いたものは有効期限が24時間に規制されたりします。  
そのためCookieを使わない方法にしています。
## 画面詳細
- メディア画面
  - TOP画面（/media/）
    - 広告リンクを貼り付けるメディア画面です。
- 広告主側画面
  - LP画面（/client/lp）
    - メディアTOPの広告リンクから遷移するページ。
    - 商品・サービスの訴求を行うページです。
  - CV画面（/client/conversion）
    - LPから成果発生アクション(商品購入など)で遷移するページです。
- 管理画面（ログイン処理実装）
  - TOP画面（/admin/）
    - プロモーション発行画面と成果確認画面へのリンクのみ置いてあります。
  - プロモーション発行画面（/admin/issuePromotion）
    - プロモーション名を入力してプロモーション（広告の１施策の単位）を発行します。
  - プロモーション発行完了画面（/admin/issueComplete）
    - プロモーション発行が完了して、メディアと広告主側ページに貼り付けるタグが表示されます。
    - タグを貼り付けることで広告として動作します。
  - 成果確認画面（/media/showResults）
    - プロモーションごとのクリック数・成果発生数を確認できます。
    - 成果発生ページ・CVページ・サンクスページなど呼び方は様々。
## 学んだこと
- コンテナ開発
  - Docker
  - コンテナ間通信
  - コンテナを利用したマイグレーション
  - コンテナの起動順制御
  - ENTRYPOINTを利用したコンテナ起動後のスクリプト実行
- Nuxt
  - Nuxtの基礎
    - ルーティング
    - ページ遷移
    - パラメータ受け渡し
  - 非同期通信
  - TypeScriptを利用したサーバーサイドAPI実装
  - Nuxtのserverディレクトリの使い方
  - storesディレクトリを使った状態管理
  - Cookieを使った状態管理のリロード対策
  - composaplesディレクトリを使ったコンポーネント実装
  - DB接続
